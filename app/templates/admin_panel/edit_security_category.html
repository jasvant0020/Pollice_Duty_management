{% extends 'admin_panel/admin_base.html' %}
{% block page_title %}Edit Security Category{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold text-gray-800 mb-6">Edit Security Category</h1>

<div class="bg-white shadow rounded-xl p-6 max-w-xl">
    <form method="POST">
        {% csrf_token %}
        {% include "error_message/error_message.html" %}

        <!-- Category Name -->
        <label class="block mb-2 font-medium text-gray-700">Category Name</label>
        <input type="text" name="name" placeholder="Category Name" required
               value="{{ category.name }}"
               class="w-full text-gray-800 p-2 mb-4 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" readonly>

        <!-- Total Personnel -->
        <div class="mb-6 p-4 bg-blue-50 rounded-xl border border-blue-200">
                <label for="total_personnel" class="block mb-1 text-sm font-medium uppercase text-blue-700">Total Personnel (Auto-Calculated)</label>
                <input type="text" id="total_personnel" name="total_personnel" value="{{ category.total_personnel }}" readonly
                    class="w-full text-4xl font-extrabold text-blue-800 bg-transparent p-1 cursor-default select-none border-none focus:outline-none">
        </div>

        <!-- Personnel by Rank -->
        <h2 class="text-xl font-semibold text-gray-700 mb-2">Personnel by Rank</h2>
        {% for rank in police_rank %}
            <label class="block mb-1 text-gray-800"><input type="checkbox" class="toggle-rank" data-rank="{{ rank.police_rank|slugify }}"> {{ rank.police_rank }}</label>
            <input type="number" name="rank_{{ rank.police_rank|slugify }}" style="display:none;"
                class="rank-input w-full text-gray-800 p-2 mb-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 valid:border-green-500">
        {% endfor %}

        <!-- Submit Button -->
        <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Save Category</button>
    </form>
</div>
</div>
<script>

// script to show checkbox for rank selection
document.querySelectorAll('.toggle-rank').forEach(cb => {
    cb.addEventListener('change', function() {
        const input = document.querySelector(`input[name="rank_${this.dataset.rank}"]`);
        
        if (this.checked) {
            input.style.display = 'block';
            input.focus();
            // Set value to 1 if empty, to ensure it contributes to total if checked
            if (!input.value || parseInt(input.value) === 0) {
                input.value = 1; 
            }
        } else {
            input.style.display = 'none';
            input.value = ''; // Clear value on uncheck
        }
        updateTotal();
    });
});
const totalInput = document.getElementById("total_personnel");
const rankInputs = document.querySelectorAll(".rank-input");

function updateTotal() {
    let sum = 0;
    rankInputs.forEach(i => sum += parseInt(i.value) || 0);
    totalInput.value = sum;
}

document.querySelectorAll(".toggle-rank").forEach(cb => {
    cb.addEventListener("change", function () {
        const input = document.querySelector(
            `input[name="rank_${this.dataset.key}"]`
        );

        if (this.checked) {
            input.style.display = "block";
            if (!input.value) input.value = 1;
        } else {
            input.style.display = "none";
            input.value = "";
        }
        updateTotal(); // âœ… recalc only after change
    });
});

rankInputs.forEach(i =>
    i.addEventListener("input", updateTotal)
);

// Ensure at least one rank input is filled before submitting
    document.querySelector("form").addEventListener("submit", function (e) {
        let valid = false;

        document.querySelectorAll('.toggle-rank').forEach(cb => {
            if (cb.checked) {
                const input = document.querySelector(`input[name="rank_${this.dataset.rank}"]`);
                if (input.value && parseInt(input.value) > 0) {
                    valid = true;
                }
            }
        });

        if (!valid) {
            e.preventDefault();
            alert("Please fill at least one field");
        }
    });

</script>
{% endblock %}
